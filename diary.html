<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å¤´ç—›æ—¥è®°é—®å·</title>
  <style>
    :root {
      --bg: #f7f3ea;
      --card: #ffffff;
      --ink: #1f2937;
      --muted: #6b7280;
      --accent: #1d4ed8;
      --line: #e5e7eb;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Noto Sans SC", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      color: var(--ink);
      background: radial-gradient(circle at top, #fff7e6 0%, var(--bg) 45%, #fdfbf7 100%);
    }
    main {
      max-width: 860px;
      margin: 28px auto 64px;
      padding: 0 16px;
    }
    header {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 18px 22px;
      box-shadow: 0 10px 24px rgba(31, 41, 55, 0.08);
      margin-bottom: 18px;
    }
    h1 { margin: 0 0 6px; font-size: 26px; }
    header p { margin: 0; color: var(--muted); }
    header a { color: var(--accent); text-decoration: none; font-size: 14px; }
    h2 { margin: 0 0 10px; font-size: 18px; }
    form {
      display: grid;
      gap: 14px;
    }
    fieldset {
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 16px 18px 18px;
      background: var(--card);
      box-shadow: 0 6px 18px rgba(31, 41, 55, 0.05);
    }
    legend {
      font-weight: 600;
      padding: 0 6px;
      font-size: 17px;
    }
    label { display: block; font-weight: 600; margin-bottom: 6px; }
    input[type="text"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--line);
      font-size: 14px;
    }
    textarea { min-height: 90px; resize: vertical; }
    .row {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      margin-bottom: 10px;
    }
    .options {
      display: flex;
      flex-wrap: wrap;
      gap: 10px 16px;
      margin: 6px 0 10px;
    }
    .option { display: flex; align-items: center; gap: 6px; }
    .actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    button {
      border: 0;
      border-radius: 10px;
      padding: 10px 16px;
      font-size: 15px;
      cursor: pointer;
    }
    .primary { background: var(--accent); color: #fff; }
    .ghost { background: #eef2ff; color: #1f2937; }
    .status { color: var(--muted); font-size: 13px; }
    .history {
      margin-top: 18px;
    }
    .history-list {
      display: grid;
      gap: 10px;
    }
    .history-item {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px 14px;
      display: grid;
      gap: 6px;
      background: #fffdf9;
    }
    .history-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 12px;
      font-size: 13px;
      color: var(--muted);
    }
    .history-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      background: #eef2ff;
      color: #1f2937;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <main>
    <header>
      <h1>å¤´ç—›æ—¥è®°</h1>
      <p>å‡†ç¡®è®°å½•æ˜¯è¯Šæ–­å’Œæ²»ç–—çš„å…³é”®ç¬¬ä¸€æ­¥ã€‚</p>
      <p><a href="/summary.html">æŸ¥çœ‹æ±‡æ€»</a></p>
    </header>

    <form id="diary-form">
      <fieldset>
        <legend>ğŸ“… åŸºæœ¬ä¿¡æ¯</legend>
        <div class="row">
          <div>
            <label for="date">æ—¥æœŸ</label>
            <input id="date" name="date" type="date" />
          </div>
          <div>
            <label for="duration">ç–¼ç—›æŒç»­æ—¶é—´ï¼ˆå°æ—¶ï¼‰</label>
            <select id="duration" name="duration">
              <option value="">è¯·é€‰æ‹©å°æ—¶æ•°</option>
              <option value="0">0</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
              <option value="7">7</option>
              <option value="8">8</option>
              <option value="9">9</option>
              <option value="10">10</option>
              <option value="11">11</option>
              <option value="12">12</option>
              <option value="13">13</option>
              <option value="14">14</option>
              <option value="15">15</option>
              <option value="16">16</option>
              <option value="17">17</option>
              <option value="18">18</option>
              <option value="19">19</option>
              <option value="20">20</option>
              <option value="21">21</option>
              <option value="22">22</option>
              <option value="23">23</option>
              <option value="24">24</option>
            </select>
          </div>
        </div>
      </fieldset>

      <fieldset>
        <legend>ğŸ©º ç—‡çŠ¶è®°å½•</legend>
        <label>æ€»ä½“æ„Ÿå—</label>
        <div class="options">
          <label class="option"><input type="radio" name="overall" value="very_bad" /> ğŸ˜© å¾ˆå·®</label>
          <label class="option"><input type="radio" name="overall" value="normal" /> ğŸ˜ ä¸€èˆ¬</label>
          <label class="option"><input type="radio" name="overall" value="very_good" /> ğŸ˜Š å¾ˆå¥½</label>
        </div>

        <label>æ˜¯å¦å¤´ç—›</label>
        <div class="options">
          <label class="option"><input type="radio" name="headache" value="yes" /> æ˜¯</label>
          <label class="option"><input type="radio" name="headache" value="no" /> å¦</label>
        </div>

        <label>å¤´ç—›ç¨‹åº¦</label>
        <div class="options">
          <label class="option"><input type="radio" name="severity" value="mild" /> â˜ï¸ è½»åº¦</label>
          <label class="option"><input type="radio" name="severity" value="moderate" /> ğŸŒ§ï¸ ä¸­åº¦</label>
          <label class="option"><input type="radio" name="severity" value="severe" /> â›ˆï¸ ä¸¥é‡</label>
        </div>

        <div class="row">
          <div>
            <label>æ•æ„Ÿç—‡çŠ¶</label>
            <div class="options">
              <label class="option"><input type="checkbox" name="sensitivity" value="light" /> æ€•å…‰äº®</label>
              <label class="option"><input type="checkbox" name="sensitivity" value="sound" /> æ€•å£°éŸ³</label>
            </div>
          </div>
          <div>
            <label>ä¼´éšç—‡çŠ¶</label>
            <div class="options">
              <label class="option"><input type="checkbox" name="symptoms" value="nausea" /> æ¶å¿ƒ</label>
              <label class="option"><input type="checkbox" name="symptoms" value="stomach" /> è‚ èƒƒä¸é€‚</label>
            </div>
          </div>
        </div>

        <label for="other-symptoms">å…¶ä»–ç—‡çŠ¶</label>
        <textarea id="other-symptoms" name="other_symptoms" placeholder="å¯è¡¥å……ä»»ä½•å…¶ä»–ä¸é€‚ç—‡çŠ¶"></textarea>
      </fieldset>

      <fieldset>
        <legend>ğŸŒ¡ï¸ èº«ä½“çŠ¶å†µ</legend>
        <div class="options">
          <label class="option"><input type="checkbox" name="condition" value="menstruation" /> æ˜¯å¦æœˆç»æœŸ</label>
          <label class="option"><input type="checkbox" name="condition" value="stress" /> æ˜¯å¦æœ‰å‹åŠ›</label>
          <label class="option"><input type="checkbox" name="condition" value="anxiety" /> æ˜¯å¦ç„¦è™‘</label>
          <label class="option"><input type="checkbox" name="condition" value="sleep" /> æ˜¯å¦ç¡çœ ä¸å¥½</label>
          <label class="option"><input type="checkbox" name="condition" value="no_meal" /> æ˜¯å¦ä¸åƒæ­£é¤</label>
          <label class="option"><input type="checkbox" name="condition" value="other_disease" /> æ˜¯å¦å› å…¶ä»–ç–¾ç—…æ„Ÿåˆ°ä¸é€‚</label>
        </div>
        <label for="other-condition">å…¶ä»–èº«ä½“çŠ¶å†µ</label>
        <textarea id="other-condition" name="other_condition" placeholder="è¡¥å……ä»»ä½•èº«ä½“çŠ¶å†µ"></textarea>
      </fieldset>

      <fieldset>
        <legend>ğŸƒ è¿åŠ¨åŠæ—¥å¸¸æ´»åŠ¨</legend>
        <div class="options">
          <label class="option"><input type="checkbox" name="activity" value="walk" /> æ˜¯å¦æ•£æ­¥</label>
          <label class="option"><input type="checkbox" name="activity" value="exercise" /> æ˜¯å¦é”»ç‚¼</label>
          <label class="option"><input type="checkbox" name="activity" value="meditation" /> æ˜¯å¦å†¥æƒ³/ç‘œä¼½</label>
          <label class="option"><input type="checkbox" name="activity" value="work" /> èƒ½å¦ç…§å¸¸å·¥ä½œ/å­¦ä¹ </label>
        </div>
      </fieldset>

      <fieldset>
        <legend>ğŸ’Š ç”¨è¯æƒ…å†µ</legend>
        <label>æ˜¯å¦æœç”¨è¯ç‰©</label>
        <div class="options">
          <label class="option"><input type="radio" name="medication" value="yes" /> æ˜¯</label>
          <label class="option"><input type="radio" name="medication" value="no" /> å¦</label>
        </div>

        <label for="med-name">è¯å</label>
        <input id="med-name" name="med_name" type="text" placeholder="å¡«å†™è¯å" />

        <label>è¯æ•ˆåé¦ˆ</label>
        <div class="options">
          <label class="option"><input type="radio" name="med_effect" value="none" /> ğŸ”´ å®Œå…¨æ— æ•ˆ</label>
          <label class="option"><input type="radio" name="med_effect" value="partial" /> ğŸŸ¡ éƒ¨åˆ†æœ‰æ•ˆ</label>
          <label class="option"><input type="radio" name="med_effect" value="good" /> ğŸŸ¢ éå¸¸æœ‰æ•ˆ</label>
        </div>

        <label for="side-effects">å‰¯ä½œç”¨ï¼ˆè¯ååŠååº”ï¼‰</label>
        <input id="side-effects" name="side_effects" type="text" placeholder="ä¾‹å¦‚ï¼šå¸ƒæ´›èŠ¬ï¼Œè½»å¾®èƒƒç—›" />

        <label for="dose">æ˜¯å¦å¢åŠ å‰‚é‡ï¼ˆè¯åï¼‰</label>
        <input id="dose" name="dose" type="text" placeholder="å¦‚æ— å¯ç•™ç©º" />

        <label for="rescue">æ˜¯å¦æœç”¨è¡¥æ•‘è¯ç‰©ï¼ˆè¯åï¼‰</label>
        <input id="rescue" name="rescue" type="text" placeholder="å¦‚æ— å¯ç•™ç©º" />
      </fieldset>

      <fieldset>
        <legend>ğŸ“ å…¶ä»–è®°å½•</legend>
        <label for="notes">å¤‡æ³¨</label>
        <textarea id="notes" name="notes" placeholder="åœ¨æ­¤å¤„è¾“å…¥ä»»ä½•å…¶ä»–å¤‡æ³¨..."></textarea>
        <div class="actions">
          <button class="primary" type="submit">æäº¤å¹¶ä¿å­˜</button>
          <button class="ghost" type="reset">æ¸…ç©ºè¡¨å•</button>
          <span class="status" id="status"></span>
        </div>
      </fieldset>
    </form>

    <section class="card history">
      <h2>å†å²è®°å½•</h2>
      <div class="status" id="history-status">æ­£åœ¨åŠ è½½...</div>
      <div class="history-list" id="history-list"></div>
      <div class="actions">
        <button class="ghost" type="button" id="load-more">åŠ è½½æ›´å¤š</button>
      </div>
    </section>
  </main>

  <script>
    const form = document.getElementById("diary-form");
    const statusEl = document.getElementById("status");
    const dateInput = document.getElementById("date");
    const submitBtn = form.querySelector("button[type='submit']");
    const historyStatus = document.getElementById("history-status");
    const historyList = document.getElementById("history-list");
    const loadMoreBtn = document.getElementById("load-more");
    let historyCursor = null;
    let editingKey = null;

    function toPayload(formEl) {
      const data = new FormData(formEl);
      const payload = {};

      for (const [key, value] of data.entries()) {
        if (payload[key] === undefined) {
          payload[key] = value;
        } else if (Array.isArray(payload[key])) {
          payload[key].push(value);
        } else {
          payload[key] = [payload[key], value];
        }
      }

      return payload;
    }

    function setEditingState(key) {
      editingKey = key;
      submitBtn.textContent = key ? "æ›´æ–°å¹¶ä¿å­˜" : "æäº¤å¹¶ä¿å­˜";
    }

    function fillForm(data) {
      form.reset();
      const entries = Object.entries(data || {});
      for (const [name, value] of entries) {
        const fields = form.querySelectorAll(`[name="${name}"]`);
        if (!fields.length) {
          continue;
        }
        fields.forEach((field) => {
          if (field.type === "checkbox") {
            const list = Array.isArray(value) ? value : [value];
            field.checked = list.includes(field.value);
          } else if (field.type === "radio") {
            field.checked = field.value === value;
          } else {
            field.value = value ?? "";
          }
        });
      }
      if (dateInput && data?.date) {
        dateInput.value = data.date;
      }
    }

    function renderHistoryItem(item) {
      const record = item.record || {};
      const data = record.data || {};
      const date = data.date || item.key.split(":")[1] || "-";
      const headache = data.headache === "yes" ? "æœ‰å¤´ç—›" : data.headache === "no" ? "æ— å¤´ç—›" : "æœªå¡«";
      const severityMap = { mild: "è½»åº¦", moderate: "ä¸­åº¦", severe: "ä¸¥é‡" };
      const severity = severityMap[data.severity] || "æœªå¡«";
      const duration = data.duration ? `${data.duration} å°æ—¶` : "æœªå¡«";

      const wrapper = document.createElement("div");
      wrapper.className = "history-item";
      wrapper.innerHTML = `
        <div><strong>${date}</strong></div>
        <div class="history-meta">
          <span class="tag">${headache}</span>
          <span class="tag">å¼ºåº¦ï¼š${severity}</span>
          <span class="tag">æŒç»­ï¼š${duration}</span>
        </div>
        <div class="history-actions">
          <button type="button" data-action="edit">ç¼–è¾‘</button>
          <button type="button" data-action="delete" class="ghost">åˆ é™¤</button>
        </div>
      `;

      wrapper.querySelector("[data-action='edit']").addEventListener("click", () => {
        fillForm(data);
        setEditingState(item.key);
        statusEl.textContent = "å·²è¿›å…¥ç¼–è¾‘æ¨¡å¼";
        window.scrollTo({ top: 0, behavior: "smooth" });
      });

      wrapper.querySelector("[data-action='delete']").addEventListener("click", async () => {
        if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ")) {
          return;
        }
        try {
          const response = await fetch(`/api?key=${encodeURIComponent(item.key)}`, { method: "DELETE" });
          const result = await response.json();
          if (response.ok && result.ok) {
            statusEl.textContent = "åˆ é™¤æˆåŠŸ";
            await loadHistory(true);
          } else {
            statusEl.textContent = result.error || "åˆ é™¤å¤±è´¥";
          }
        } catch (error) {
          statusEl.textContent = "ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥ã€‚";
        }
      });

      historyList.appendChild(wrapper);
    }

    async function loadHistory(reset = false) {
      if (reset) {
        historyList.innerHTML = "";
        historyCursor = null;
      }
      historyStatus.textContent = "åŠ è½½ä¸­...";
      loadMoreBtn.disabled = true;
      const cursorParam = historyCursor ? `&cursor=${encodeURIComponent(historyCursor)}` : "";

      try {
        const response = await fetch(`/api?limit=10${cursorParam}`);
        const result = await response.json();
        if (response.ok && result.ok) {
          result.items.forEach(renderHistoryItem);
          historyCursor = result.cursor;
          historyStatus.textContent = result.items.length ? "" : "æš‚æ— å†å²è®°å½•";
          loadMoreBtn.style.display = historyCursor ? "inline-flex" : "none";
        } else {
          historyStatus.textContent = result.error || "è·å–å¤±è´¥";
        }
      } catch (error) {
        historyStatus.textContent = "ç½‘ç»œé”™è¯¯";
      } finally {
        loadMoreBtn.disabled = false;
      }
    }

    if (dateInput && !dateInput.value) {
      dateInput.value = new Date().toISOString().slice(0, 10);
    }

    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      statusEl.textContent = "æ­£åœ¨æäº¤...";
      submitBtn.disabled = true;

      try {
        const payload = toPayload(form);
        const isEditing = Boolean(editingKey);
        const response = await fetch("/api", {
          method: isEditing ? "PUT" : "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify(isEditing ? { key: editingKey, data: payload } : payload),
        });
        const result = await response.json();

        if (response.ok && result.ok) {
          statusEl.textContent = isEditing ? "æ›´æ–°æˆåŠŸ" : `æäº¤æˆåŠŸï¼Œç¼–å·ï¼š${result.key}`;
          form.reset();
          setEditingState(null);
          if (dateInput) {
            dateInput.value = new Date().toISOString().slice(0, 10);
          }
          await loadHistory(true);
        } else {
          statusEl.textContent = "æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚";
        }
      } catch (error) {
        statusEl.textContent = "ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥ã€‚";
      } finally {
        submitBtn.disabled = false;
      }
    });

    form.addEventListener("reset", () => {
      setEditingState(null);
    });

    loadMoreBtn.addEventListener("click", () => loadHistory(false));
    loadHistory(true);
  </script>
</body>
</html>
