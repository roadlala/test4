<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ•°æ®ç®¡ç†ä¸­å¿ƒ</title>
  <style>
    :root {
      --bg: #f6f2ea;
      --card: #ffffff;
      --ink: #1f2937;
      --muted: #6b7280;
      --accent: #0f766e;
      --line: #e5e7eb;
      --accent-soft: #e8f6f2;
      --peach: #f7b27a;
      --rose: #f28b82;
      --sun: #f5cf5a;
      --sky: #8ab4f8;
      --sage: #7fc8a9;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Avenir Next", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      color: var(--ink);
      background: radial-gradient(circle at top, #fff8ef 0%, var(--bg) 45%, #fdfaf4 100%);
    }
    main {
      max-width: 1200px;
      margin: 28px auto 64px;
      padding: 0 16px;
      display: grid;
      gap: 16px;
    }
    header {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 18px 22px;
      box-shadow: 0 12px 28px rgba(31, 41, 55, 0.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    h1 { margin: 0 0 6px; font-size: 26px; }
    h2 { margin: 0 0 12px; font-size: 18px; }
    header p { margin: 0; color: var(--muted); }
    a { color: var(--accent); text-decoration: none; }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 16px 18px;
      box-shadow: 0 6px 18px rgba(31, 41, 55, 0.05);
      animation: rise 0.6s ease both;
    }
    @keyframes rise {
      from { transform: translateY(10px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .toolbar {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      align-items: end;
    }
    label { display: block; font-size: 13px; color: var(--muted); margin-bottom: 6px; }
    input[type="text"],
    input[type="date"],
    input[type="password"],
    select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid var(--line);
      font-size: 14px;
      background: #fff;
    }
    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    button {
      border: 0;
      border-radius: 12px;
      padding: 9px 14px;
      background: var(--accent);
      color: #fff;
      font-size: 14px;
      cursor: pointer;
    }
    button.ghost {
      background: var(--accent-soft);
      color: #0f4c43;
    }

    .stats {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    }
    .stat {
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px 14px;
      background: linear-gradient(140deg, #fdf6ee 0%, #ffffff 60%);
      display: grid;
      gap: 6px;
    }
    .stat strong { font-size: 20px; }
    .stat span { color: var(--muted); font-size: 12px; }

    .layout {
      display: grid;
      gap: 16px;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 0.8fr);
      align-items: start;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    .table th, .table td {
      text-align: left;
      padding: 10px 8px;
      border-bottom: 1px solid var(--line);
    }
    .table th { color: var(--muted); font-weight: 600; }
    .sortable {
      cursor: pointer;
      position: relative;
      padding-right: 20px;
    }
    .sortable::after {
      content: \"â†•\";
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 12px;
      color: var(--muted);
    }
    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
      background: #eef2ff;
    }
    .tag.warn { background: #fff1f2; color: #9f1239; }
    .tag.ok { background: #ecfdf3; color: #166534; }

    .row-actions {
      display: flex;
      gap: 6px;
    }
    .row-actions button {
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
    }

    .editor {
      position: sticky;
      top: 16px;
      display: grid;
      gap: 12px;
    }
    fieldset {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px 14px 14px;
      background: #fff;
    }
    legend { font-weight: 600; font-size: 14px; padding: 0 4px; }
    .options {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 12px;
      margin-top: 8px;
    }
    textarea {
      width: 100%;
      min-height: 80px;
      border-radius: 12px;
      border: 1px solid var(--line);
      padding: 8px 10px;
      font-size: 14px;
      resize: vertical;
    }
    .muted { color: var(--muted); font-size: 13px; }

    @media (max-width: 980px) {
      .layout { grid-template-columns: 1fr; }
      .editor { position: static; }
    }
  </style>
</head>
<body>
  <main>
    <header>
      <div>
        <h1>æ•°æ®ç®¡ç†ä¸­å¿ƒ</h1>
        <p>é¢å‘ä¸“ä¸šæ•´ç†ä¸è¡¥å½•çš„è®°å½•ç¼–è¾‘å°ã€‚</p>
      </div>
      <div class="actions">
        <a href="/diary.html">è¿”å›å¡«å†™é¡µ</a>
        <a href="/summary/">æŸ¥çœ‹æ±‡æ€»</a>
      </div>
    </header>

    <section class="card">
      <div class="toolbar">
        <div>
          <label for="search">å…³é”®è¯æœç´¢</label>
          <input id="search" type="text" placeholder="ç—‡çŠ¶ã€è¯åã€å¤‡æ³¨..." />
        </div>
        <div>
          <label for="headache-filter">å¤´ç—›çŠ¶æ€</label>
          <select id="headache-filter">
            <option value="all" selected>å…¨éƒ¨</option>
            <option value="yes">æœ‰å¤´ç—›</option>
            <option value="no">æ— å¤´ç—›</option>
            <option value="unknown">æœªå¡«</option>
          </select>
        </div>
        <div>
          <label for="severity-filter">å¼ºåº¦ç­›é€‰</label>
          <select id="severity-filter">
            <option value="all" selected>å…¨éƒ¨</option>
            <option value="severe">ä¸¥é‡</option>
            <option value="moderate">ä¸­åº¦</option>
            <option value="mild">è½»åº¦</option>
            <option value="unknown">æœªå¡«</option>
          </select>
        </div>
        <div>
          <label for="start-date">å¼€å§‹æ—¥æœŸ</label>
          <input id="start-date" type="date" />
        </div>
        <div>
          <label for="end-date">ç»“æŸæ—¥æœŸ</label>
          <input id="end-date" type="date" />
        </div>
        <div>
          <label for="sort">æ’åº</label>
          <select id="sort">
            <option value="date_desc" selected>æ—¥æœŸ æ–°â†’æ—§</option>
            <option value="date_asc">æ—¥æœŸ æ—§â†’æ–°</option>
            <option value="severity_desc">å¼ºåº¦ é«˜â†’ä½</option>
            <option value="duration_desc">æŒç»­æ—¶é—´ é«˜â†’ä½</option>
            <option value="headache_yes">å¤´ç—›ä¼˜å…ˆ</option>
          </select>
        </div>
      </div>
      <div class="actions" style="margin-top: 12px;">
        <button id="refresh">åˆ·æ–°åˆ—è¡¨</button>
        <button id="load-more" class="ghost">åŠ è½½æ›´å¤š</button>
        <button id="load-all" class="ghost">åŠ è½½å…¨éƒ¨</button>
        <span class="muted" id="status"></span>
      </div>
    </section>

    <section class="card">
      <div class="stats" id="stats"></div>
    </section>

    <section class="layout">
      <div class="card">
        <h2>å†å²è®°å½•</h2>
        <table class="table">
          <thead>
            <tr>
              <th class="sortable" data-sort="date_desc">æ—¥æœŸ</th>
              <th>å¤´ç—›</th>
              <th class="sortable" data-sort="severity_desc">å¼ºåº¦</th>
              <th class="sortable" data-sort="duration_desc">æŒç»­</th>
              <th>ç”¨è¯</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="record-list"></tbody>
        </table>
      </div>

      <div class="card editor">
        <h2>ç¼–è¾‘è®°å½•</h2>
        <div class="muted" id="editor-status">è¯·é€‰æ‹©ä¸€æ¡è®°å½•è¿›è¡Œç¼–è¾‘</div>
        <form id="editor-form">
          <fieldset>
            <legend>ğŸ“… åŸºæœ¬ä¿¡æ¯</legend>
            <label for="date">æ—¥æœŸ</label>
            <input id="date" name="date" type="date" />
            <label for="duration">ç–¼ç—›æŒç»­æ—¶é—´ï¼ˆå°æ—¶ï¼‰</label>
            <select id="duration" name="duration">
              <option value="">è¯·é€‰æ‹©å°æ—¶æ•°</option>
              <option value="0">0</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
              <option value="7">7</option>
              <option value="8">8</option>
              <option value="9">9</option>
              <option value="10">10</option>
              <option value="11">11</option>
              <option value="12">12</option>
              <option value="13">13</option>
              <option value="14">14</option>
              <option value="15">15</option>
              <option value="16">16</option>
              <option value="17">17</option>
              <option value="18">18</option>
              <option value="19">19</option>
              <option value="20">20</option>
              <option value="21">21</option>
              <option value="22">22</option>
              <option value="23">23</option>
              <option value="24">24</option>
            </select>
          </fieldset>

          <fieldset>
            <legend>ğŸ©º ç—‡çŠ¶</legend>
            <label>æ€»ä½“æ„Ÿå—</label>
            <div class="options">
              <label><input type="radio" name="overall" value="very_bad" /> ğŸ˜© å¾ˆå·®</label>
              <label><input type="radio" name="overall" value="normal" /> ğŸ˜ ä¸€èˆ¬</label>
              <label><input type="radio" name="overall" value="very_good" /> ğŸ˜Š å¾ˆå¥½</label>
            </div>

            <label>æ˜¯å¦å¤´ç—›</label>
            <div class="options">
              <label><input type="radio" name="headache" value="yes" /> æ˜¯</label>
              <label><input type="radio" name="headache" value="no" /> å¦</label>
            </div>

            <label>å¤´ç—›ç¨‹åº¦</label>
            <div class="options">
              <label><input type="radio" name="severity" value="mild" /> â˜ï¸ è½»åº¦</label>
              <label><input type="radio" name="severity" value="moderate" /> ğŸŒ§ï¸ ä¸­åº¦</label>
              <label><input type="radio" name="severity" value="severe" /> â›ˆï¸ ä¸¥é‡</label>
            </div>

            <label>æ•æ„Ÿç—‡çŠ¶</label>
            <div class="options">
              <label><input type="checkbox" name="sensitivity" value="light" /> æ€•å…‰äº®</label>
              <label><input type="checkbox" name="sensitivity" value="sound" /> æ€•å£°éŸ³</label>
            </div>

            <label>ä¼´éšç—‡çŠ¶</label>
            <div class="options">
              <label><input type="checkbox" name="symptoms" value="nausea" /> æ¶å¿ƒ</label>
              <label><input type="checkbox" name="symptoms" value="stomach" /> è‚ èƒƒä¸é€‚</label>
            </div>

            <label for="other-symptoms">å…¶ä»–ç—‡çŠ¶</label>
            <textarea id="other-symptoms" name="other_symptoms"></textarea>
          </fieldset>

          <fieldset>
            <legend>ğŸŒ¡ï¸ èº«ä½“çŠ¶å†µ</legend>
            <div class="options">
              <label><input type="checkbox" name="condition" value="menstruation" /> æœˆç»æœŸ</label>
              <label><input type="checkbox" name="condition" value="stress" /> å‹åŠ›</label>
              <label><input type="checkbox" name="condition" value="anxiety" /> ç„¦è™‘</label>
              <label><input type="checkbox" name="condition" value="sleep" /> ç¡çœ å·®</label>
              <label><input type="checkbox" name="condition" value="no_meal" /> æœªè¿›é£Ÿ</label>
              <label><input type="checkbox" name="condition" value="other_disease" /> å…¶ä»–ç—…ç—‡</label>
            </div>
            <label for="other-condition">å…¶ä»–èº«ä½“çŠ¶å†µ</label>
            <textarea id="other-condition" name="other_condition"></textarea>
          </fieldset>

          <fieldset>
            <legend>ğŸƒ æ´»åŠ¨</legend>
            <div class="options">
              <label><input type="checkbox" name="activity" value="walk" /> æ•£æ­¥</label>
              <label><input type="checkbox" name="activity" value="exercise" /> é”»ç‚¼</label>
              <label><input type="checkbox" name="activity" value="meditation" /> å†¥æƒ³/ç‘œä¼½</label>
              <label><input type="checkbox" name="activity" value="work" /> èƒ½ç…§å¸¸å·¥ä½œ/å­¦ä¹ </label>
            </div>
          </fieldset>

          <fieldset>
            <legend>ğŸ’Š ç”¨è¯</legend>
            <label>æ˜¯å¦æœç”¨è¯ç‰©</label>
            <div class="options">
              <label><input type="radio" name="medication" value="yes" /> æ˜¯</label>
              <label><input type="radio" name="medication" value="no" /> å¦</label>
            </div>

            <label for="med-name">è¯å</label>
            <input id="med-name" name="med_name" type="text" />

            <label>è¯æ•ˆåé¦ˆ</label>
            <div class="options">
              <label><input type="radio" name="med_effect" value="none" /> ğŸ”´ å®Œå…¨æ— æ•ˆ</label>
              <label><input type="radio" name="med_effect" value="partial" /> ğŸŸ¡ éƒ¨åˆ†æœ‰æ•ˆ</label>
              <label><input type="radio" name="med_effect" value="good" /> ğŸŸ¢ éå¸¸æœ‰æ•ˆ</label>
            </div>

            <label for="side-effects">å‰¯ä½œç”¨ï¼ˆè¯ååŠååº”ï¼‰</label>
            <input id="side-effects" name="side_effects" type="text" />

            <label for="dose">æ˜¯å¦å¢åŠ å‰‚é‡ï¼ˆè¯åï¼‰</label>
            <input id="dose" name="dose" type="text" />

            <label for="rescue">æ˜¯å¦æœç”¨è¡¥æ•‘è¯ç‰©ï¼ˆè¯åï¼‰</label>
            <input id="rescue" name="rescue" type="text" />
          </fieldset>

          <fieldset>
            <legend>ğŸ“ å¤‡æ³¨</legend>
            <textarea id="notes" name="notes"></textarea>
          </fieldset>

          <div class="actions">
            <input id="passcode" name="passcode" type="password" placeholder="å¡«å†™å£ä»¤" />
            <button type="submit">ä¿å­˜ä¿®æ”¹</button>
            <button type="button" class="ghost" id="cancel-edit">å–æ¶ˆç¼–è¾‘</button>
          </div>
        </form>
      </div>
    </section>
  </main>

  <script>
    const recordList = document.getElementById("record-list");
    const statsWrap = document.getElementById("stats");
    const statusEl = document.getElementById("status");
    const refreshBtn = document.getElementById("refresh");
    const loadMoreBtn = document.getElementById("load-more");
    const loadAllBtn = document.getElementById("load-all");
    const searchInput = document.getElementById("search");
    const headacheFilter = document.getElementById("headache-filter");
    const severityFilter = document.getElementById("severity-filter");
    const startDateInput = document.getElementById("start-date");
    const endDateInput = document.getElementById("end-date");
    const sortSelect = document.getElementById("sort");
    const sortableHeaders = document.querySelectorAll(".sortable");
    const editorForm = document.getElementById("editor-form");
    const editorStatus = document.getElementById("editor-status");
    const cancelEditBtn = document.getElementById("cancel-edit");
    const passcodeInput = document.getElementById("passcode");

    let cursor = null;
    let loading = false;
    let records = [];
    let editingKey = null;

    function getRecordDate(item) {
      const dataDate = typeof item.record?.data?.date === "string" ? item.record.data.date.trim() : "";
      if (dataDate) {
        return dataDate.slice(0, 10);
      }
      return item.key.split(":")[1] || "";
    }

    function severityScore(value) {
      if (value === "severe") return 3;
      if (value === "moderate") return 2;
      if (value === "mild") return 1;
      return 0;
    }

    function toPayload(formEl) {
      const data = new FormData(formEl);
      const payload = {};

      for (const [key, value] of data.entries()) {
        if (payload[key] === undefined) {
          payload[key] = value;
        } else if (Array.isArray(payload[key])) {
          payload[key].push(value);
        } else {
          payload[key] = [payload[key], value];
        }
      }
      return payload;
    }

    function fillForm(data) {
      editorForm.reset();
      const entries = Object.entries(data || {});
      for (const [name, value] of entries) {
        const fields = editorForm.querySelectorAll(`[name="${name}"]`);
        if (!fields.length) {
          continue;
        }
        fields.forEach((field) => {
          if (field.type === "checkbox") {
            const list = Array.isArray(value) ? value : [value];
            field.checked = list.includes(field.value);
          } else if (field.type === "radio") {
            field.checked = field.value === value;
          } else {
            field.value = value ?? "";
          }
        });
      }
    }

    function setEditing(key, data) {
      editingKey = key;
      if (key) {
        fillForm(data || {});
        editorStatus.textContent = `æ­£åœ¨ç¼–è¾‘ï¼š${getRecordDate({ key, record: { data } })}`;
      } else {
        editorForm.reset();
        editorStatus.textContent = "è¯·é€‰æ‹©ä¸€æ¡è®°å½•è¿›è¡Œç¼–è¾‘";
      }
    }

    function applyFilters(items) {
      const keyword = searchInput.value.trim().toLowerCase();
      const headache = headacheFilter.value;
      const severity = severityFilter.value;
      const startDate = startDateInput.value;
      const endDate = endDateInput.value;

      return items.filter((item) => {
        const data = item.record?.data || {};
        const date = getRecordDate(item);

        if (headache !== "all" && (data.headache || "unknown") !== headache) {
          return false;
        }
        if (severity !== "all" && (data.severity || "unknown") !== severity) {
          return false;
        }
        if (startDate && date < startDate) {
          return false;
        }
        if (endDate && date > endDate) {
          return false;
        }
        if (keyword) {
          const haystack = [
            data.notes,
            data.med_name,
            data.other_symptoms,
            data.other_condition,
          ].filter(Boolean).join(" ").toLowerCase();
          if (!haystack.includes(keyword)) {
            return false;
          }
        }
        return true;
      });
    }

    function applySort(items) {
      const mode = sortSelect.value;
      return [...items].sort((a, b) => {
        const dateA = getRecordDate(a);
        const dateB = getRecordDate(b);
        const dataA = a.record?.data || {};
        const dataB = b.record?.data || {};

        if (mode === "date_asc") {
          return dateA.localeCompare(dateB);
        }
        if (mode === "date_desc") {
          return dateB.localeCompare(dateA);
        }
        if (mode === "severity_desc") {
          return severityScore(dataB.severity) - severityScore(dataA.severity);
        }
        if (mode === "duration_desc") {
          const durA = Number.parseFloat(dataA.duration) || 0;
          const durB = Number.parseFloat(dataB.duration) || 0;
          return durB - durA;
        }
        if (mode === "headache_yes") {
          return (dataB.headache === "yes") - (dataA.headache === "yes");
        }
        return 0;
      });
    }

    function renderStats(items) {
      statsWrap.innerHTML = "";
      const total = items.length;
      const headacheYes = items.filter((item) => item.record?.data?.headache === "yes").length;
      const severeCount = items.filter((item) => item.record?.data?.severity === "severe").length;
      const avgDuration = total
        ? (items.reduce((sum, item) => sum + (Number.parseFloat(item.record?.data?.duration) || 0), 0) / total).toFixed(1)
        : "0.0";

      const cards = [
        { label: "å½“å‰ç»“æœæ•°", value: total },
        { label: "å¤´ç—›è®°å½•æ•°", value: headacheYes },
        { label: "ä¸¥é‡æ¬¡æ•°", value: severeCount },
        { label: "å¹³å‡æ—¶é•¿", value: `${avgDuration} å°æ—¶` },
      ];
      cards.forEach((card) => {
        const node = document.createElement("div");
        node.className = "stat";
        node.innerHTML = `<strong>${card.value}</strong><span>${card.label}</span>`;
        statsWrap.appendChild(node);
      });
    }

    function renderList() {
      const filtered = applyFilters(records);
      const sorted = applySort(filtered);
      recordList.innerHTML = "";
      renderStats(sorted);

      if (!sorted.length) {
        recordList.innerHTML = "<tr><td colspan=\"6\" class=\"muted\">æš‚æ— è®°å½•</td></tr>";
        return;
      }

      sorted.forEach((item) => {
        const data = item.record?.data || {};
        const date = getRecordDate(item);
        const headache = data.headache === "yes" ? "æœ‰" : data.headache === "no" ? "æ— " : "æœªå¡«";
        const severityMap = { mild: "è½»åº¦", moderate: "ä¸­åº¦", severe: "ä¸¥é‡" };
        const severity = severityMap[data.severity] || "æœªå¡«";
        const duration = data.duration ? `${data.duration} å°æ—¶` : "æœªå¡«";
        const medication = data.medication === "yes" ? "æ˜¯" : data.medication === "no" ? "å¦" : "æœªå¡«";

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${date}</td>
          <td><span class="tag ${headache === "æœ‰" ? "warn" : "ok"}">${headache}</span></td>
          <td>${severity}</td>
          <td>${duration}</td>
          <td>${medication}</td>
          <td>
            <div class="row-actions">
              <button type="button" data-action="edit">ç¼–è¾‘</button>
              <button type="button" data-action="delete" class="ghost">åˆ é™¤</button>
            </div>
          </td>
        `;

        row.querySelector("[data-action='edit']").addEventListener("click", () => {
          setEditing(item.key, data);
        });

        row.querySelector("[data-action='delete']").addEventListener("click", async () => {
          if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ")) {
            return;
          }
          await deleteRecord(item.key);
        });

        recordList.appendChild(row);
      });
    }

    async function fetchRecords(reset = false) {
      if (loading) return;
      loading = true;
      statusEl.textContent = "åŠ è½½ä¸­...";
      if (reset) {
        cursor = null;
        records = [];
      }

      const cursorParam = cursor ? `&cursor=${encodeURIComponent(cursor)}` : "";
      try {
        const response = await fetch(`/api?limit=50${cursorParam}`);
        const result = await response.json();
        if (response.ok && result.ok) {
          records = records.concat(result.items);
          cursor = result.cursor;
          statusEl.textContent = cursor ? "ä»æœ‰æ›´å¤šè®°å½•" : "å·²åŠ è½½å…¨éƒ¨";
          loadMoreBtn.disabled = !cursor;
        } else {
          statusEl.textContent = result.error || "è·å–å¤±è´¥";
        }
      } catch (error) {
        statusEl.textContent = "ç½‘ç»œé”™è¯¯";
      } finally {
        loading = false;
        renderList();
      }
    }

    async function loadAll() {
      while (cursor) {
        await fetchRecords(false);
      }
    }

    async function deleteRecord(key) {
      const passcode = passcodeInput?.value?.trim();
      if (!passcode) {
        statusEl.textContent = "è¯·å…ˆè¾“å…¥å£ä»¤";
        return;
      }
      try {
        const response = await fetch(`/api?key=${encodeURIComponent(key)}`, {
          method: "DELETE",
          headers: { "x-passcode": passcode },
        });
        const result = await response.json();
        if (response.ok && result.ok) {
          records = records.filter((item) => item.key !== key);
          if (editingKey === key) {
            setEditing(null, null);
          }
          renderList();
          statusEl.textContent = "åˆ é™¤æˆåŠŸ";
        } else {
          statusEl.textContent = result.error || "åˆ é™¤å¤±è´¥";
        }
      } catch (error) {
        statusEl.textContent = "ç½‘ç»œé”™è¯¯";
      }
    }

    editorForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      if (!editingKey) {
        editorStatus.textContent = "è¯·å…ˆé€‰æ‹©ä¸€æ¡è®°å½•";
        return;
      }
      editorStatus.textContent = "ä¿å­˜ä¸­...";
      const payload = toPayload(editorForm);
      if (!payload.passcode) {
        editorStatus.textContent = "è¯·å…ˆè¾“å…¥å£ä»¤";
        return;
      }
      try {
        const response = await fetch("/api", {
          method: "PUT",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ key: editingKey, data: payload }),
        });
        const result = await response.json();
        if (response.ok && result.ok) {
          const index = records.findIndex((item) => item.key === editingKey);
          if (index >= 0) {
            records[index].record = { ...records[index].record, data: payload };
          }
          editorStatus.textContent = "å·²ä¿å­˜";
          renderList();
        } else {
          editorStatus.textContent = result.error || "ä¿å­˜å¤±è´¥";
          if (response.status === 404) {
            statusEl.textContent = "è®°å½•å·²ä¸å­˜åœ¨ï¼Œå¯èƒ½è¢«åˆ é™¤ã€‚";
          }
        }
      } catch (error) {
        editorStatus.textContent = "ç½‘ç»œé”™è¯¯";
      }
    });

    cancelEditBtn.addEventListener("click", () => setEditing(null, null));

    [searchInput, headacheFilter, severityFilter, startDateInput, endDateInput, sortSelect].forEach((el) => {
      el.addEventListener("input", renderList);
    });

    sortableHeaders.forEach((header) => {
      header.addEventListener("click", () => {
        const nextSort = header.dataset.sort;
        sortSelect.value = nextSort;
        renderList();
      });
    });

    refreshBtn.addEventListener("click", () => fetchRecords(true));
    loadMoreBtn.addEventListener("click", () => fetchRecords(false));
    loadAllBtn.addEventListener("click", loadAll);

    fetchRecords(true);
  </script>
</body>
</html>
